# After you push to main, App Platform deploys. This workflow waits for the
# deploy to finish, then purges Cloudflare cache so visitors see the new version.
#
# Required GitHub secrets (Settings → Secrets and variables → Actions):
#   CLOUDFLARE_ZONE_ID   – Zone ID from Cloudflare dashboard (Overview, right sidebar)
#   CLOUDFLARE_API_TOKEN – API token with "Cache Purge" permission

name: Purge Cloudflare after deploy

on:
  push:
    branches: [main]
  workflow_dispatch: # "Run workflow" in Actions tab to purge cache manually

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for App Platform deploy
        run: |
          echo "Waiting 3 minutes for DigitalOcean App Platform to build and deploy..."
          sleep 180
        if: github.event_name == 'push'

      - name: Purge Cloudflare cache
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -z "$CLOUDFLARE_ZONE_ID" ] || [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "::warning:: CLOUDFLARE_ZONE_ID or CLOUDFLARE_API_TOKEN not set. Skip purge. Add them in repo Settings → Secrets and variables → Actions."
            exit 0
          fi
          echo "Purging Cloudflare cache..."
          resp=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')
          body=$(echo "$resp" | head -n -1)
          code=$(echo "$resp" | tail -n 1)
          if [ "$code" = "200" ]; then
            echo "Cache purged successfully."
          else
            echo "::error:: Cloudflare purge failed (HTTP $code): $body"
            exit 1
          fi
